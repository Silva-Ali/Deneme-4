<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silva | Aktif Stok Takip Sistemi v2.4</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2c3e50;
            --primary-light: #eaf2fb;
            --secondary-color: #50E3C2;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #9b59b6;
            --ship-color: #16a085;
            --background-color: #f4f7fc;
            --card-background-color: #ffffff;
            --text-color: #333;
            --light-text-color: #7f8c8d;
            --border-color: #e0e6ed;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --font-family: 'Poppins', sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem 1rem; }
        header { background: linear-gradient(135deg, var(--primary-dark), #1d2b4e); color: white; padding: 2rem; text-align: center; border-radius: 0 0 20px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        header h1 { font-weight: 700; font-size: 2.5rem; }
        main { display: grid; grid-template-columns: 1fr; gap: 2rem; margin-top: 2rem; }
        @media (min-width: 992px) { main { grid-template-columns: 380px 1fr; } }
        .card, .summary-card { background-color: var(--card-background-color); border-radius: 12px; box-shadow: var(--box-shadow); padding: 1.5rem; transition: all 0.3s ease; }
        .card:hover, .summary-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
        .card-title { margin-bottom: 1.5rem; font-weight: 600; font-size: 1.25rem; color: var(--primary-dark); border-bottom: 2px solid var(--border-color); padding-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
        .summary-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .summary-card { text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .summary-card h2 { font-size: 1rem; font-weight: 500; color: var(--light-text-color); margin-bottom: 0.5rem; }
        .summary-card p { font-weight: 700; margin-bottom: 0; line-height: 1.2; word-break: break-all; }
        .summary-card .main-value { font-size: clamp(1.5rem, 4vw, 2.2rem); }
        .summary-card .sub-value { font-size: clamp(1rem, 3vw, 1.4rem); font-weight: 500; color: var(--light-text-color); }
        #total-stock .main-value { color: var(--primary-color); }
        #in-stock .main-value { color: var(--secondary-color); }
        #in-transit .main-value { color: var(--warning-color); }
        #on-plane .main-value { color: var(--info-color); }
        #on-ship .main-value { color: var(--ship-color); }
        #total-value .main-value { color: #27ae60; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .price-input-group { display: flex; gap: 0.5rem; align-items: center; }
        .price-input-group .input-field { flex-grow: 1; }
        .price-input-group .select-field { width: 80px; flex-shrink: 0; }
        .input-field, .select-field { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; font-family: var(--font-family); transition: all 0.3s ease; }
        .input-field:focus, .select-field:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        .input-field.invalid { border-color: var(--danger-color); box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2); }
        .btn { padding: 0.9rem 1.5rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background-color: var(--primary-color); color: white; width: 100%; }
        .btn-primary:hover { background-color: #2980b9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4); }
        .btn-secondary { background-color: var(--secondary-color); color: white; width: 100%; }
        .btn-secondary:hover { background-color: #48CFAF; }
        .btn-cancel { background-color: #ecf0f1; color: var(--light-text-color); width: 100%; margin-top: 0.5rem; }
        .btn-cancel:hover { background-color: #bdc3c7; }
        .btn-action { background-color: transparent; border: 1px solid var(--border-color); color: var(--light-text-color); padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        .btn-action:hover { border-color: var(--primary-color); color: var(--primary-color); background: var(--primary-light); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger-outline { background-color: transparent; border: 1px solid var(--border-color); color: var(--danger-color); padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        .btn-danger-outline:hover { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
        .product-actions { display: flex; gap: 0.5rem; }
        #list-controls-wrapper { margin-bottom: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        #product-list-controls { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: space-between; align-items: center; }
        #search-box { width: 100%; max-width: 250px; }
        #sort-controls { display: flex; align-items: center; gap: 0.5rem; }
        .filter-buttons { display: flex; gap: 0.5rem; background-color: #e9ecef; padding: 5px; border-radius: 8px; flex-wrap: wrap;}
        .filter-btn { background: transparent; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .filter-btn.active { background: var(--card-background-color); color: var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
        #product-list { margin-top: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .product-item { display: grid; grid-template-columns: 1fr auto; align-items: center; padding: 1rem 1.25rem; border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.5s ease; opacity: 1; transform: scale(1); }
        .product-item.removing { opacity: 0; transform: scale(0.95) translateX(30px); }
        .product-info .product-name { font-weight: 600; font-size: 1.1rem; }
        .product-info .product-meta { color: var(--light-text-color); font-size: 0.9rem; }
        .product-meta .price-usd { color: var(--text-color); font-weight: 500; }
        .product-details { display: flex; align-items: center; gap: 1rem; }
        .product-status { padding: 0.3rem 0.8rem; border-radius: 20px; font-weight: 500; font-size: 0.8rem; color: white; text-align: center; min-width: 80px; }
        .status-Stokta { background-color: var(--secondary-color); }
        .status-Yolda { background-color: var(--warning-color); }
        .status-U√ßakta { background-color: var(--info-color); }
        .status-Gemide { background-color: var(--ship-color); }
        .placeholder-message { text-align: center; padding: 3rem 1rem; border: 2px dashed var(--border-color); border-radius: 12px; }
        .placeholder-message p { color: var(--light-text-color); font-weight: 500; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { display: flex; align-items: center; gap: 10px; padding: 1rem 1.5rem; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateX(120%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { background: linear-gradient(135deg, var(--secondary-color), #2ecc71); }
        .toast-info { background: linear-gradient(135deg, var(--danger-color), #c0392b); }
        .toast-warning { background: linear-gradient(135deg, var(--primary-color), #2980b9); }
        #add-product-panel.editing { border: 2px solid var(--secondary-color); box-shadow: 0 8px 25px rgba(80, 227, 194, 0.3); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; transform: scale(0.9); transition: all 0.3s ease; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-content h3 { margin-bottom: 1rem; }
        .modal-content p { margin-bottom: 1.5rem; color: var(--light-text-color); }
        .modal-actions { display: flex; justify-content: center; gap: 1rem; }
    </style>
</head>
<body>

    <header>
        <h1>Silva | Aktif Stok Takip Sistemi <sub>v2.4</sub></h1>
    </header>

    <div class="container">
        <section id="summary-section">
            <div class="summary-container">
                <div class="summary-card" id="total-value">
                    <h2>üíµ TOPLAM STOK DEƒûERƒ∞</h2>
                    <p id="total-value-tl" class="main-value">‚Ç∫0</p>
                    <p id="total-value-usd" class="sub-value">$0</p>
                </div>
                <div class="summary-card" id="total-stock">
                    <h2>üì¶ TOPLAM STOK</h2>
                    <p class="main-value">0</p>
                </div>
                <div class="summary-card" id="in-stock">
                    <h2>‚úÖ STOKTA</h2>
                    <p class="main-value">0</p>
                </div>
                <div class="summary-card" id="in-transit">
                    <h2>üöö YOLDA</h2>
                    <p class="main-value">0</p>
                </div>
                 <div class="summary-card" id="on-ship">
                    <h2>üö¢ GEMƒ∞DE</h2>
                    <p class="main-value">0</p>
                </div>
                <div class="summary-card" id="on-plane">
                    <h2>‚úàÔ∏è U√áAKTA</h2>
                    <p class="main-value">0</p>
                </div>
            </div>
        </section>

        <main>
            <aside id="add-product-panel">
                <div class="card">
                    <h2 class="card-title" id="form-title">Yeni √úr√ºn Ekle</h2>
                    <form id="add-product-form">
                        <input type="hidden" id="edit-product-id">
                        <div class="form-group">
                            <label for="product-name">√úr√ºn Adƒ±</label>
                            <input type="text" id="product-name" class="input-field" placeholder="√ñrn: El Mopu" required>
                        </div>
                        <div class="form-group">
                            <label for="product-price">Birim Fiyat</label>
                            <div class="price-input-group">
                                <input type="number" id="product-price" class="input-field" placeholder="√ñrn: 250" min="0" step="0.01" required>
                                <select id="price-currency" class="select-field">
                                    <option value="TRY">‚Ç∫</option>
                                    <option value="USD">$</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="product-quantity">Adet</label>
                            <input type="number" id="product-quantity" class="input-field" placeholder="√ñrn: 50" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="product-status">Durum</label>
                            <select id="product-status" class="select-field">
                                <option value="Stokta">Stokta</option>
                                <option value="Yolda">Yolda</option>
                                <option value="Gemide">Gemide</option>
                                <option value="U√ßakta">U√ßakta</option>
                            </select>
                        </div>
                        <div id="form-buttons">
                            <button type="submit" class="btn btn-primary" id="submit-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m-7-7h14"/></svg>
                                <span>Stoƒüa Ekle</span>
                            </button>
                            <button type="button" class="btn btn-cancel" id="cancel-edit-btn" style="display: none;">ƒ∞ptal</button>
                        </div>
                    </form>
                </div>
            </aside>
            <section id="product-list-section" class="card">
                <div class="card-title">
                    <span>Stok Listesi</span>
                    <button class="btn btn-action" id="export-csv-btn" title="Verileri CSV olarak indir">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        <span>Dƒ±≈üa Aktar</span>
                    </button>
                </div>
                <div id="list-controls-wrapper">
                    <div id="product-list-controls">
                        <input type="search" id="search-box" class="input-field" placeholder="üîç √úr√ºnlerde ara...">
                        <div id="sort-controls">
                            <label for="sort-by" style="font-weight: 500;">Sƒ±rala:</label>
                            <select id="sort-by" class="select-field">
                                <option value="createdAt_desc">Tarihe G√∂re (En Yeni)</option>
                                <option value="createdAt_asc">Tarihe G√∂re (En Eski)</option>
                                <option value="name_asc">√úr√ºn Adƒ± (A-Z)</option>
                                <option value="name_desc">√úr√ºn Adƒ± (Z-A)</option>
                                <option value="price_asc">Fiyata G√∂re (Artan)</option>
                                <option value="price_desc">Fiyata G√∂re (Azalan)</option>
                                <option value="quantity_asc">Adede G√∂re (Artan)</option>
                                <option value="quantity_desc">Adede G√∂re (Azalan)</option>
                            </select>
                        </div>
                    </div>
                     <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="T√ºm√º">T√ºm√º</button>
                        <button class="filter-btn" data-filter="Stokta">Stokta</button>
                        <button class="filter-btn" data-filter="Yolda">Yolda</button>
                        <button class="filter-btn" data-filter="Gemide">Gemide</button>
                        <button class="filter-btn" data-filter="U√ßakta">U√ßakta</button>
                    </div>
                </div>
                <div id="product-list">
                     <div class="placeholder-message">
                        <div class="loading-spinner"></div>
                        <p>Veriler Y√ºkleniyor...</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="toast-container"></div>
    
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Onay Gerekiyor</h3>
            <p>Bu √ºr√ºn√º kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.</p>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="btn btn-cancel">Vazge√ß</button>
                <button id="modal-confirm-btn" class="btn btn-danger">Evet, Sil</button>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyASCeVzpEOhDCHyWTeza7Rnbm4U8EUc5QE",
            authDomain: "stokdepo-52630.firebaseapp.com",
            databaseURL: "https://stokdepo-52630-default-rtdb.firebaseio.com",
            projectId: "stokdepo-52630",
            storageBucket: "stokdepo-52630.appspot.com",
            messagingSenderId: "698156957113",
            appId: "1:698156957113:web:632e25ada3a3bfdc9e0a68",
            measurementId: "G-45QFTCYQJF"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const productsRef = db.ref('products');

        document.addEventListener('DOMContentLoaded', async () => {
            // Element References
            const addProductPanel = document.getElementById('add-product-panel');
            const addProductForm = document.getElementById('add-product-form');
            const formTitle = document.getElementById('form-title');
            const submitBtn = document.getElementById('submit-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const editProductIdInput = document.getElementById('edit-product-id');
            const productNameInput = document.getElementById('product-name');
            const productPriceInput = document.getElementById('product-price');
            const priceCurrencySelect = document.getElementById('price-currency');
            const productQuantityInput = document.getElementById('product-quantity');
            const productStatusSelect = document.getElementById('product-status');
            const productListDiv = document.getElementById('product-list');
            const toastContainer = document.getElementById('toast-container');
            const searchBox = document.getElementById('search-box');
            const filterButtonsContainer = document.querySelector('.filter-buttons');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const sortBySelect = document.getElementById('sort-by');
            const deleteModal = document.getElementById('delete-modal');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');

            // State Variables
            let allProducts = [];
            let searchTerm = '';
            let activeFilter = 'T√ºm√º';
            let activeSort = 'createdAt_desc';
            let usdToTryRate = 35.0; // Fallback
            let productToDeleteId = null;

            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                const icons = { success: '‚úÖ', info: 'üóëÔ∏è', warning: '‚úèÔ∏è', rate: '‚ÑπÔ∏è' };
                toast.innerHTML = `<span>${icons[type] || '‚ÑπÔ∏è'}</span><span>${message}</span>`;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 4000);
            };

            const formatCurrency = (amount, currency = 'TRY') => {
                 return new Intl.NumberFormat(currency === 'TRY' ? 'tr-TR' : 'en-US', {
                    style: 'currency', currency: currency, maximumFractionDigits: 2
                }).format(amount);
            };

            const fetchAndUpdateRate = async () => {
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    if (!response.ok) throw new Error('Network response failed.');
                    const data = await response.json();
                    if (data && data.rates && data.rates.TRY) {
                        usdToTryRate = data.rates.TRY;
                        showToast(`G√ºncel kur: 1 USD = ${usdToTryRate.toFixed(2)} TL`, 'rate');
                    }
                } catch (error) {
                    console.error("Could not fetch exchange rate, using fallback.", error);
                    showToast(`Kur alƒ±namadƒ±, yakla≈üƒ±k deƒüer kullanƒ±lƒ±yor.`, 'info');
                }
            };

            const updateSummary = () => {
                const totalStock = allProducts.reduce((sum, p) => sum + p.quantity, 0);
                const inStock = allProducts.filter(p => p.status === 'Stokta').reduce((sum, p) => sum + p.quantity, 0);
                const inTransit = allProducts.filter(p => p.status === 'Yolda').reduce((sum, p) => sum + p.quantity, 0);
                const onShip = allProducts.filter(p => p.status === 'Gemide').reduce((sum, p) => sum + p.quantity, 0);
                const onPlane = allProducts.filter(p => p.status === 'U√ßakta').reduce((sum, p) => sum + p.quantity, 0);
                const totalValueTL = allProducts.reduce((sum, p) => sum + (p.quantity * p.price), 0);
                const totalValueUSD = totalValueTL / usdToTryRate;

                document.querySelector('#total-stock .main-value').textContent = totalStock;
                document.querySelector('#in-stock .main-value').textContent = inStock;
                document.querySelector('#in-transit .main-value').textContent = inTransit;
                document.querySelector('#on-ship .main-value').textContent = onShip;
                document.querySelector('#on-plane .main-value').textContent = onPlane;
                document.querySelector('#total-value-tl').textContent = formatCurrency(totalValueTL, 'TRY');
                document.querySelector('#total-value-usd').textContent = formatCurrency(totalValueUSD, 'USD');
            };
            
            const renderProducts = () => {
                // 1. Filter
                let processedProducts = allProducts;
                if (activeFilter !== 'T√ºm√º') {
                    processedProducts = processedProducts.filter(p => p.status === activeFilter);
                }
                if (searchTerm) {
                    processedProducts = processedProducts.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
                }

                // 2. Sort
                const [key, direction] = activeSort.split('_');
                processedProducts.sort((a, b) => {
                    let valA = a[key];
                    let valB = b[key];
                    if (key === 'name') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });

                // 3. Render
                productListDiv.innerHTML = '';
                if (processedProducts.length === 0) {
                     productListDiv.innerHTML = `<div class="placeholder-message"><p>G√∂sterilecek √ºr√ºn bulunamadƒ±.</p></div>`;
                } else {
                    processedProducts.forEach(product => {
                        const productElement = document.createElement('div');
                        productElement.className = 'product-item';
                        productElement.dataset.id = product.id;
                        const priceUSD = product.price / usdToTryRate;
                        productElement.innerHTML = `
                            <div class="product-info">
                                <span class="product-name">${product.name}</span>
                                <div class="product-meta">
                                    <span>${product.quantity} Adet</span> &bull;
                                    <span class="price-usd">${formatCurrency(product.price, 'TRY')} / ${formatCurrency(priceUSD, 'USD')}</span>
                                </div>
                            </div>
                            <div class="product-details">
                                <span class="product-status status-${product.status}">${product.status}</span>
                                <div class="product-actions">
                                    <button class="btn btn-action edit-btn" title="D√ºzenle">‚úèÔ∏è</button>
                                    <button class="btn btn-danger-outline delete-btn" title="Sil">üóëÔ∏è</button>
                                </div>
                            </div>`;
                        productListDiv.appendChild(productElement);
                    });
                }
            };

            const resetForm = () => {
                addProductForm.reset();
                editProductIdInput.value = '';
                priceCurrencySelect.value = 'TRY';
                formTitle.textContent = 'Yeni √úr√ºn Ekle';
                submitBtn.querySelector('span').textContent = 'Stoƒüa Ekle';
                submitBtn.classList.remove('btn-secondary');
                submitBtn.classList.add('btn-primary');
                addProductPanel.classList.remove('editing');
                cancelEditBtn.style.display = 'none';
                document.querySelectorAll('.input-field.invalid').forEach(el => el.classList.remove('invalid'));
            };

            const validateForm = () => {
                let isValid = true;
                document.querySelectorAll('.input-field.invalid').forEach(el => el.classList.remove('invalid'));
                if (!productNameInput.value.trim()) {
                    productNameInput.classList.add('invalid');
                    isValid = false;
                }
                const price = parseFloat(productPriceInput.value);
                if (isNaN(price) || price < 0) {
                    productPriceInput.classList.add('invalid');
                    isValid = false;
                }
                const quantity = parseInt(productQuantityInput.value);
                if (isNaN(quantity) || quantity <= 0) {
                    productQuantityInput.classList.add('invalid');
                    isValid = false;
                }
                return isValid;
            };

            addProductForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!validateForm()) {
                    showToast('L√ºtfen kƒ±rmƒ±zƒ± alanlarƒ± d√ºzeltin.', 'info');
                    return;
                }

                const price = parseFloat(productPriceInput.value);
                const currency = priceCurrencySelect.value;
                const priceInTry = currency === 'USD' ? price * usdToTryRate : price;

                const productData = {
                    name: productNameInput.value.trim(),
                    price: priceInTry,
                    quantity: parseInt(productQuantityInput.value),
                    status: productStatusSelect.value
                };
                const editId = editProductIdInput.value;

                if (editId) {
                    productsRef.child(editId).update(productData)
                        .then(() => {
                            showToast('√úr√ºn ba≈üarƒ±yla g√ºncellendi!', 'success');
                            resetForm();
                        });
                } else {
                    productData.createdAt = firebase.database.ServerValue.TIMESTAMP;
                    productsRef.push(productData)
                        .then(() => {
                            showToast('√úr√ºn ba≈üarƒ±yla kaydedildi!', 'success');
                            resetForm();
                            productNameInput.focus();
                        });
                }
            });

            productListDiv.addEventListener('click', (e) => {
                const editButton = e.target.closest('.edit-btn');
                if (editButton) {
                    const productId = editButton.closest('.product-item').dataset.id;
                    const product = allProducts.find(p => p.id === productId);
                    if (product) {
                        editProductIdInput.value = product.id;
                        productNameInput.value = product.name;
                        productPriceInput.value = product.price.toFixed(2);
                        priceCurrencySelect.value = 'TRY'; // Always edit in TRY
                        productQuantityInput.value = product.quantity;
                        productStatusSelect.value = product.status;
                        formTitle.textContent = '√úr√ºn√º D√ºzenle';
                        submitBtn.querySelector('span').textContent = 'Deƒüi≈üiklikleri Kaydet';
                        submitBtn.classList.replace('btn-primary', 'btn-secondary');
                        addProductPanel.classList.add('editing');
                        cancelEditBtn.style.display = 'block';
                        productNameInput.focus();
                        showToast(`"${product.name}" d√ºzenleniyor...`, 'warning');
                    }
                }

                const deleteButton = e.target.closest('.delete-btn');
                if (deleteButton) {
                    productToDeleteId = deleteButton.closest('.product-item').dataset.id;
                    deleteModal.classList.add('show');
                }
            });

            modalConfirmBtn.addEventListener('click', () => {
                if(productToDeleteId){
                    productsRef.child(productToDeleteId).remove()
                        .then(() => showToast('√úr√ºn silindi.', 'info'));
                    deleteModal.classList.remove('show');
                    productToDeleteId = null;
                }
            });

            modalCancelBtn.addEventListener('click', () => deleteModal.classList.remove('show'));
            deleteModal.addEventListener('click', (e) => {
                if(e.target === deleteModal) deleteModal.classList.remove('show');
            });

            cancelEditBtn.addEventListener('click', resetForm);
            searchBox.addEventListener('input', (e) => { searchTerm = e.target.value; renderProducts(); });
            sortBySelect.addEventListener('change', (e) => { activeSort = e.target.value; renderProducts(); });
            filterButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    filterButtonsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    activeFilter = e.target.dataset.filter;
                    renderProducts();
                }
            });

            exportCsvBtn.addEventListener('click', () => {
                if (allProducts.length === 0) {
                    showToast('Dƒ±≈üa aktarƒ±lacak √ºr√ºn yok.', 'info'); return;
                }
                const headers = '√úr√ºn Adƒ±,Birim Fiyat (TL),Birim Fiyat (USD),Adet,Durum,Toplam Deƒüer (TL),Toplam Deƒüer (USD)\n';
                const rows = allProducts.map(p => {
                    const totalTL = p.price * p.quantity;
                    const priceUSD = p.price / usdToTryRate;
                    const totalUSD = totalTL / usdToTryRate;
                    return `"${p.name}",${p.price.toFixed(2)},${priceUSD.toFixed(2)},${p.quantity},${p.status},${totalTL.toFixed(2)},${totalUSD.toFixed(2)}`;
                }).join('\n');
                
                const blob = new Blob([`\uFEFF${headers + rows}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'stok-listesi.csv';
                link.click();
                URL.revokeObjectURL(link.href);
                showToast('Stok listesi indiriliyor...', 'success');
            });
            
            await fetchAndUpdateRate();

            productsRef.on('value', snapshot => {
                const productsData = snapshot.val();
                allProducts = productsData ? Object.keys(productsData).map(key => ({ id: key, ...productsData[key] })) : [];
                updateSummary();
                renderProducts();
            });
        });
    </script>
</body>
</html>

