<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipari≈ü Takip Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: The application is designed as a dynamic, single-page dashboard with a layered structure. The core is a central data store (Firebase Firestore), making the app dynamic and collaborative. The main UI features a top-level tabbed navigation to switch between the 'Ana Panel' (main dashboard) and 'Yeni Sipari≈ü' (new order entry form). The Ana Panel itself is a comprehensive dashboard with KPI cards for real-time metrics, interactive charts for high-level data exploration, and a sortable/filterable data table for detailed inspection. The core interaction model is a drill-down approach, where clicking on any element (KPI card, chart segment, table row) opens a modal with more granular details and interactive controls, including new editing and deletion capabilities. This structure prioritizes user task flow, allowing for quick overviews, deep dives, and data entry, all within a single, cohesive experience. -->
    <!-- Visualization & Content Choices: 
        - Firebase & User ID Display: (Goal: Inform/Organize) Displays user authentication and provides a unique ID for collaboration. Method: Dynamic text block updated by JS. Justification: Critical for demonstrating the multi-user, collaborative nature of the app and for debugging.
        - KPI Cards: (Goal: Inform) Used for key metrics including revenue, order counts, and real-time status counts (e.g., 'Yolda'). Method: Stylish HTML/Tailwind cards with icons and hover effects. Interaction: Clickable to show related orders in a modal. Justification: Provides instant, high-level, and interactive insights into operational status.
        - Orders Table: (Goal: Organize/Inform) A detailed, filterable, and sortable table with status and human-readable dates. Method: HTML Table with dynamic content filtered by JS. Interaction: Rows are clickable to show order details in a modal, which now includes edit and delete options. Justification: Remains the core source for detailed transaction data.
        - Doughnut Chart (Revenue by Product): (Goal: Compare) Visualizes revenue contribution by product. Method: Chart.js Canvas. Interaction: Clicking a segment opens a modal with orders for that product. Justification: Excellent for visualizing part-to-whole relationships.
        - Bar Chart (Orders by Month): (Goal: Change/Compare) Displays order volume trends over time. Method: Chart.js Canvas. Interaction: Clicking a bar opens a modal with a list of monthly orders. Justification: Ideal for identifying trends and comparing quantities across time periods.
        - Gemini Summary Section: (Goal: Analyze) A dedicated section for AI-generated summaries. Method: A dynamic text block updated via a Fetch API call. Interaction: User-initiated via buttons. Justification: Transforms the app into an AI-powered business intelligence tool, providing instant, high-level analysis and valuable insights.
        - D√º≈ü√ºk Stok Uyarƒ±sƒ±: (Goal: Inform/Warn) A specific KPI card to alert users of low stock. Method: A dedicated HTML/Tailwind card that appears dynamically based on data. Justification: Provides a critical, immediate warning for a key business metric.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f2;
        }
        .container-main {
            background-color: #f8f7f4;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 1rem;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 4px 12px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900">Sipari≈ü Takip Paneli</h1>
            <p class="text-lg text-gray-600 mt-2">Sipari≈ü verilerinin genel durumu ve √ºr√ºn performans analizleri.</p>
        </header>

        <nav class="flex justify-center mb-8">
            <button id="tab-panel" class="tab-button px-6 py-2 border-b-2 border-transparent hover:border-indigo-600 transition-colors duration-300 font-semibold text-gray-600">Ana Panel</button>
            <button id="tab-add" class="tab-button px-6 py-2 border-b-2 border-transparent hover:border-indigo-600 transition-colors duration-300 font-semibold text-gray-600">Yeni Sipari≈ü Ekle</button>
        </nav>

        <main id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8 p-6 container-main">
            <!-- Ana Panel View -->
            <div id="panel-view" class="lg:col-span-3 grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <section id="kpi-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></section>
                    <div id="low-stock-warning" class="bg-red-50 p-6 rounded-2xl shadow-sm border border-red-200 text-red-700 hidden">
                        <div class="font-bold">‚ö†Ô∏è D√º≈ü√ºk Stok Uyarƒ±sƒ±!</div>
                        <p id="low-stock-list" class="mt-2 text-sm"></p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h2 class="text-xl font-semibold mb-1">T√ºm Sipari≈üler</h2>
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <input type="text" id="searchInput" placeholder="√úr√ºn veya sipari≈ü ara..." class="flex-grow p-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <select id="statusFilter" class="p-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="all">T√ºm Durumlar</option>
                                <option value="Stokta">Stokta</option>
                                <option value="Yolda (Gemi)">Yolda (Gemi)</option>
                                <option value="Yolda (U√ßak)">Yolda (U√ßak)</option>
                            </select>
                        </div>
                        <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Sipari≈ü Tarihi</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">√úr√ºn Adƒ±</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Adet</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Toplam Tutar</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ƒ∞≈ülemler</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-1 space-y-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h2 class="text-xl font-semibold mb-1">Genel Durum √ñzeti</h2>
                        <p class="text-sm text-gray-500 mb-4">Gemini tarafƒ±ndan olu≈üturulan sipari≈ü verilerinin kƒ±sa √∂zeti.</p>
                        <div class="flex gap-2">
                           <button id="getSummaryButton" class="flex-grow bg-indigo-600 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105">√ñzet Olu≈ütur</button>
                           <button id="getStockSummaryButton" class="flex-grow bg-purple-600 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-105">Stok Analizi</button>
                        </div>
                        <div id="summary-section" class="min-h-[100px] flex items-center justify-center p-4 rounded-lg bg-gray-50 mt-4">
                            <div id="summary-loader" class="text-center hidden">
                                <svg class="animate-spin h-6 w-6 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p class="mt-2 text-sm text-gray-500">Analiz yapƒ±lƒ±yor...</p>
                            </div>
                            <p id="summaryText" class="text-gray-700 leading-relaxed"></p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h2 class="text-xl font-semibold mb-1">√úr√ºne G√∂re Tutar Daƒüƒ±lƒ±mƒ±</h2>
                        <p class="text-sm text-gray-500 mb-4">Hangi √ºr√ºn√ºn toplam ciroya ne kadar katkƒ± saƒüladƒ±ƒüƒ±nƒ± g√∂sterir. Detaylar i√ßin dilime tƒ±klayƒ±nƒ±z.</p>
                        <div class="chart-container h-64 md:h-72">
                            <canvas id="revenueByProductChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h2 class="text-xl font-semibold mb-1">Aylara G√∂re Sipari≈ü Adetleri</h2>
                        <p class="text-sm text-gray-500 mb-4">Aylƒ±k sipari≈ü yoƒüunluƒüunu ve trendleri g√∂sterir. Detaylar i√ßin √ßubuƒüa tƒ±klayƒ±nƒ±z.</p>
                        <div class="chart-container h-64 md:h-72">
                            <canvas id="ordersByMonthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Yeni Sipari≈ü Ekle View -->
            <div id="add-order-view" class="lg:col-span-3 hidden">
                <div class="bg-white p-6 rounded-2xl shadow-sm max-w-xl mx-auto">
                    <h2 class="text-xl font-semibold mb-4">Yeni Sipari≈ü Ekle</h2>
                    <form id="addOrderForm" class="space-y-4">
                        <div>
                            <label for="orderDate" class="block text-sm font-medium text-gray-700">Sipari≈ü Tarihi</label>
                            <input type="date" id="orderDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="productName" class="block text-sm font-medium text-gray-700">√úr√ºn Adƒ±</label>
                            <input type="text" id="productName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700">Adet</label>
                            <input type="number" id="quantity" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="unitPrice" class="block text-sm font-medium text-gray-700">Birim Fiyatƒ± ($)</label>
                            <input type="number" step="0.01" id="unitPrice" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="orderStatus" class="block text-sm font-medium text-gray-700">Durum</label>
                            <select id="orderStatus" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="Yolda (Gemi)">Yolda (Gemi)</option>
                                <option value="Yolda (U√ßak)">Yolda (U√ßak)</option>
                                <option value="Stokta">Stokta</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105">Sipari≈ü Kaydet</button>
                    </form>
                    <p id="formMessage" class="mt-4 text-center text-sm"></p>
                </div>
            </div>
        </main>
    </div>

    <!-- The Modal for Order Details -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('detailsModal')">&times;</span>
            <h3 id="modalTitle" class="text-2xl font-bold mb-4"></h3>
            <div id="modalContent" class="space-y-4"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Yapƒ±landƒ±rma Bilgileri
        // Bu bilgileri Firebase Console'daki projenizden almanƒ±z gerekiyor.
        const firebaseConfig = {
            apiKey: "AIzaSyASCeVzpEOhDCHyWTeza7Rnbm4U8EUc5QE",
            authDomain: "stokdepo-52630.firebaseapp.com",
            databaseURL: "https://stokdepo-52630-default-rtdb.firebaseio.com",
            projectId: "stokdepo-52630",
            storageBucket: "stokdepo-52630.firebasestorage.app",
            messagingSenderId: "698156957113",
            appId: "1:698156957113:web:a7c769b258aa88c79e0a68",
            measurementId: "G-P20CWT8XB8"
        };
        const appId = 'deneme-4';
        const initialAuthToken = null;
        
        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        let db;
        let auth;
        let userId;
        let ordersCollection;
        let rawData = [];
        let editingOrder = null;

        const statusMap = {
            'Yolda (Gemi)': 'text-blue-500 font-semibold',
            'Yolda (U√ßak)': 'text-yellow-500 font-semibold',
            'Stokta': 'text-green-500 font-semibold'
        };

        const formatDate = (dateString) => {
            const date = new Date(dateString);
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('tr-TR', options);
        };
        const formatCurrency = (value) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'USD' }).format(value);
        const formatNumber = (value) => new Intl.NumberFormat('tr-TR').format(value);

        const panelView = document.getElementById('panel-view');
        const addOrderView = document.getElementById('add-order-view');
        const tabPanel = document.getElementById('tab-panel');
        const tabAdd = document.getElementById('tab-add');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');

        const switchView = (viewId) => {
            if (viewId === 'panel-view') {
                panelView.classList.remove('hidden');
                addOrderView.classList.add('hidden');
                tabPanel.classList.add('border-indigo-600');
                tabAdd.classList.remove('border-indigo-600');
            } else {
                panelView.classList.add('hidden');
                addOrderView.classList.remove('hidden');
                tabPanel.classList.remove('border-indigo-600');
                tabAdd.classList.add('border-indigo-600');
            }
        };

        tabPanel.addEventListener('click', () => switchView('panel-view'));
        tabAdd.addEventListener('click', () => switchView('add-order-view'));

        const renderUI = (data = rawData, lowStockProducts = []) => {
            const totalRevenue = data.reduce((sum, item) => sum + (item.qty || 0) * (item.price || 0), 0);
            const totalQuantity = data.reduce((sum, item) => sum + (item.qty || 0), 0);
            const totalOrders = data.length;
            const totalOnShip = data.filter(item => item.status === 'Yolda (Gemi)').length;
            const totalOnPlane = data.filter(item => item.status === 'Yolda (U√ßak)').length;
            const totalInStock = data.filter(item => item.status === 'Stokta').length;

            const kpiData = [
                { label: 'Toplam Tutar', value: formatCurrency(totalRevenue), icon: 'üí∞' },
                { label: 'Toplam Adet', value: formatNumber(totalQuantity), icon: 'üì¶' },
                { label: 'Sipari≈ü Sayƒ±sƒ±', value: totalOrders, icon: 'üìÑ' },
                { label: 'Yolda (Gemi)', value: totalOnShip, icon: 'üö¢', filter: 'Yolda (Gemi)' },
                { label: 'Yolda (U√ßak)', value: totalOnPlane, icon: '‚úàÔ∏è', filter: 'Yolda (U√ßak)' },
                { label: 'Stokta', value: totalInStock, icon: 'üè†', filter: 'Stokta' },
            ];

            const kpiSection = document.getElementById('kpi-section');
            kpiSection.innerHTML = '';
            kpiData.forEach(kpi => {
                const card = document.createElement('div');
                card.className = `bg-white p-5 rounded-2xl shadow-md flex items-center transition duration-300 transform hover:scale-105 cursor-pointer`;
                card.innerHTML = `
                    <div class="text-3xl mr-4">${kpi.icon}</div>
                    <div>
                        <div class="text-sm text-gray-500">${kpi.label}</div>
                        <div class="text-2xl font-bold text-gray-900">${kpi.value}</div>
                    </div>
                `;
                if (kpi.filter) {
                    card.onclick = () => showDetails(`${kpi.label} Sipari≈üleri`, data.filter(item => item.status === kpi.filter));
                }
                kpiSection.appendChild(card);
            });

            const lowStockWarning = document.getElementById('low-stock-warning');
            if (lowStockProducts.length > 0) {
                lowStockWarning.classList.remove('hidden');
                document.getElementById('low-stock-list').innerHTML = `
                    <ul class="list-disc list-inside">
                        ${lowStockProducts.map(p => `<li>**${p.name}**: ${p.qty} adet kaldƒ±.</li>`).join('')}
                    </ul>
                `;
            } else {
                lowStockWarning.classList.add('hidden');
            }

            const tableBody = document.getElementById('orders-table-body');
            tableBody.innerHTML = '';
            data.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer transition duration-150';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatDate(order.date)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${order.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatNumber(order.qty)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${formatCurrency((order.qty || 0) * (order.price || 0))}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusMap[order.status]}">${order.status}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <button onclick="event.stopPropagation(); showDetails('Sipari≈ü Detayƒ±', rawData.find(o => o.id === '${order.id}'));" class="text-indigo-600 hover:text-indigo-900 font-semibold mr-2">D√ºzenle</button>
                        <button onclick="event.stopPropagation(); deleteOrder('${order.id}');" class="text-red-600 hover:text-red-900 font-semibold">Sil</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            const productRevenue = data.reduce((acc, order) => {
                const total = (order.qty || 0) * (order.price || 0);
                acc[order.name] = (acc[order.name] || 0) + total;
                return acc;
            }, {});

            const revenueByProductCtx = document.getElementById('revenueByProductChart').getContext('2d');
            if (window.revenueChart) window.revenueChart.destroy();
            window.revenueChart = new Chart(revenueByProductCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(productRevenue),
                    datasets: [{
                        label: 'Tutar',
                        data: Object.values(productRevenue),
                        backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#3b82f6', '#ef4444'],
                        borderColor: '#ffffff',
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const productName = Object.keys(productRevenue)[index];
                            const filteredOrders = data.filter(order => order.name === productName);
                            showDetails(`${productName} Sipari≈üleri`, filteredOrders);
                        }
                    },
                    plugins: { legend: { position: 'bottom', labels: { padding: 20 } } },
                    cutout: '60%'
                }
            });

            const monthlyOrders = data.reduce((acc, order) => {
                const month = new Date(order.date).toLocaleString('tr-TR', { month: 'long', year: 'numeric' });
                acc[month] = (acc[month] || 0) + (order.qty || 0);
                return acc;
            }, {});
            
            const sortedMonths = Object.keys(monthlyOrders).sort((a, b) => {
                const [monthA, yearA] = a.split(' ');
                const [monthB, yearB] = b.split(' ');
                const monthMap = { 'Ocak': 0, '≈ûubat': 1, 'Mart': 2, 'Nisan': 3, 'Mayƒ±s': 4, 'Haziran': 5, 'Temmuz': 6, 'Aƒüustos': 7, 'Eyl√ºl': 8, 'Ekim': 9, 'Kasƒ±m': 10, 'Aralƒ±k': 11 };
                return new Date(yearA, monthMap[monthA]) - new Date(yearB, monthMap[monthB]);
            });
            const sortedQuantities = sortedMonths.map(month => monthlyOrders[month]);

            const ordersByMonthCtx = document.getElementById('ordersByMonthChart').getContext('2d');
            if (window.ordersChart) window.ordersChart.destroy();
            window.ordersChart = new Chart(ordersByMonthCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Sipari≈ü Adedi',
                        data: sortedQuantities,
                        backgroundColor: '#3b82f6',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const monthName = sortedMonths[index];
                            const filteredOrders = data.filter(order => new Date(order.date).toLocaleString('tr-TR', { month: 'long', year: 'numeric' }) === monthName);
                            showDetails(`${monthName} Sipari≈üleri`, filteredOrders);
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        };

        const showDetails = (title, data) => {
            const modal = document.getElementById('detailsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            
            if (Array.isArray(data)) {
                const tableHtml = `
                    <div class="table-container max-h-[300px]">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sipari≈ü Tarihi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√úr√ºn Adƒ±</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adet</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Toplam Tutar</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${data.map(item => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatDate(item.date)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${item.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatNumber(item.qty)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${formatCurrency((item.qty || 0) * (item.price || 0))}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm ${statusMap[item.status]}">${item.status}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                modalContent.innerHTML = tableHtml;
            } else {
                const item = data;
                editingOrder = item;
                const detailHtml = `
                    <div class="bg-gray-50 p-6 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="modalOrderDate" class="block text-sm font-medium text-gray-700">Sipari≈ü Tarihi</label>
                            <input type="date" id="modalOrderDate" value="${item.date}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="modalProductName" class="block text-sm font-medium text-gray-700">√úr√ºn Adƒ±</label>
                            <input type="text" id="modalProductName" value="${item.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="modalQuantity" class="block text-sm font-medium text-gray-700">Adet</label>
                            <input type="number" id="modalQuantity" value="${item.qty}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="modalUnitPrice" class="block text-sm font-medium text-gray-700">Birim Fiyatƒ± ($)</label>
                            <input type="number" step="0.01" id="modalUnitPrice" value="${item.price}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label for="modalOrderStatus" class="block text-sm font-medium text-gray-700">Durum</label>
                            <select id="modalOrderStatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option value="Yolda (Gemi)" ${item.status === 'Yolda (Gemi)' ? 'selected' : ''}>Yolda (Gemi)</option>
                                <option value="Yolda (U√ßak)" ${item.status === 'Yolda (U√ßak)' ? 'selected' : ''}>Yolda (U√ßak)</option>
                                <option value="Stokta" ${item.status === 'Stokta' ? 'selected' : ''}>Stokta</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-4">
                        <button id="update-button" class="flex-grow bg-green-500 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:bg-green-600 transition duration-300 transform hover:scale-105">G√ºncelle</button>
                        <button id="delete-button" class="flex-grow bg-red-500 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:bg-red-600 transition duration-300 transform hover:scale-105">Sƒ∞L</button>
                    </div>
                `;
                modalContent.innerHTML = detailHtml;

                document.getElementById('update-button').addEventListener('click', async () => {
                    const updatedOrder = {
                        date: document.getElementById('modalOrderDate').value,
                        name: document.getElementById('modalProductName').value,
                        qty: parseInt(document.getElementById('modalQuantity').value),
                        price: parseFloat(document.getElementById('modalUnitPrice').value),
                        status: document.getElementById('modalOrderStatus').value,
                    };

                    try {
                        const docRef = doc(db, ordersCollection.path, editingOrder.id);
                        await updateDoc(docRef, updatedOrder);
                        alert('Sipari≈ü ba≈üarƒ±yla g√ºncellendi.');
                        closeModal('detailsModal');
                    } catch (e) {
                        alert('Sipari≈ü g√ºncellenemedi. Hata: ' + e.message);
                    }
                });

                document.getElementById('delete-button').addEventListener('click', async () => {
                    if (confirm("Bu sipari≈üi silmek istediƒüinize emin misiniz?")) {
                        try {
                            const docRef = doc(db, ordersCollection.path, editingOrder.id);
                            await deleteDoc(docRef);
                            alert('Sipari≈ü ba≈üarƒ±yla silindi.');
                            closeModal('detailsModal');
                        } catch (e) {
                            alert('Sipari≈ü silinemedi. Hata: ' + e.message);
                        }
                    }
                });
            }
            modal.style.display = 'flex';
        };

        const closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        };

        const getSummary = async (promptType = 'general') => {
            const summaryLoader = document.getElementById('summary-loader');
            const summaryText = document.getElementById('summaryText');
            summaryLoader.classList.remove('hidden');
            summaryText.classList.add('hidden');

            const formattedData = rawData.map(order => 
                `Sipari≈ü ID: ${order.id}, Tarih: ${order.date}, √úr√ºn Adƒ±: ${order.name}, Adet: ${order.qty}, Birim Fiyat: ${order.price}, Toplam Tutar: ${(order.qty || 0) * (order.price || 0)}, Durum: ${order.status}`
            ).join('\n');
            
            let prompt = "";
            if (promptType === 'general') {
                 prompt = `A≈üaƒüƒ±daki sipari≈ü verilerini analiz et ve bir i≈ü analisti gibi davranarak √∂nemli bulgularƒ± ve anahtar metrikleri (toplam sipari≈ü sayƒ±sƒ±, toplam tutar, en √ßok satan √ºr√ºn, durum daƒüƒ±lƒ±mƒ± gibi) √∂zetle. Yanƒ±tƒ±nƒ± maddeler halinde ve profesyonel bir dille sun. Veriler:\n\n${formattedData}`;
            } else if (promptType === 'stock') {
                 prompt = `A≈üaƒüƒ±daki sipari≈ü verilerini kullanarak stok durumunu analiz et. Hangi √ºr√ºnlerin stoƒüu kritik seviyede (√∂rneƒüin 500 adetin altƒ±nda) veya tamamen t√ºkenmi≈üse, bu durumu belirt. En √ßok sipari≈ü verilen √ºr√ºnleri ve stok seviyelerini kar≈üƒ±la≈ütƒ±r. Analizini maddeler halinde ve profesyonel bir dille sun. Veriler:\n\n${formattedData}`;
            }

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: "Sen bir veri analisti ve uzman i≈ü danƒ±≈ümanƒ±sƒ±n. Verilen veriyi en √∂nemli bulgularƒ±yla birlikte √∂zetle." }]
                },
                tools: [{ "google_search": {} }]
            };
            
            let retryCount = 0;
            const maxRetries = 3;
            const baseDelay = 1000;

            const makeApiCall = async () => {
                try {
                    const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API hatasƒ±: ${response.status} - ${errorData.error.message}`);
                    }
                    
                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "√ñzet olu≈üturulamadƒ±.";
                    summaryText.innerText = text;
                    summaryLoader.classList.add('hidden');
                    summaryText.classList.remove('hidden');

                } catch (error) {
                    if (retryCount < maxRetries) {
                        const delay = baseDelay * Math.pow(2, retryCount);
                        retryCount++;
                        setTimeout(makeApiCall, delay);
                    } else {
                        summaryText.innerText = `√ñzet alƒ±namadƒ±. L√ºtfen daha sonra tekrar deneyin. Hata: ${error.message}`;
                        summaryLoader.classList.add('hidden');
                        summaryText.classList.remove('hidden');
                    }
                }
            };
            makeApiCall();
        };

        const sortTable = (columnIndex) => {
            const tableBody = document.getElementById('orders-table-body');
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            const isAscending = tableBody.getAttribute('data-sort-order') !== 'asc';
            const sortedRows = rows.sort((a, b) => {
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();
                if (columnIndex === 2 || columnIndex === 3) {
                    const aValue = parseFloat(aText.replace(/[^\d,.]/g, '').replace(',', '.'));
                    const bValue = parseFloat(bText.replace(/[^\d,.]/g, '').replace(',', '.'));
                    return isAscending ? aValue - bValue : bValue - aValue;
                }
                return isAscending ? aText.localeCompare(bText) : bText.localeCompare(aText);
            });
            tableBody.innerHTML = '';
            sortedRows.forEach(row => tableBody.appendChild(row));
            tableBody.setAttribute('data-sort-order', isAscending ? 'asc' : 'desc');
        };

        document.querySelectorAll('thead th').forEach((header, index) => {
            if (header.textContent.trim() !== 'ƒ∞≈ülemler') {
                header.addEventListener('click', () => sortTable(index));
            }
        });

        const filterTable = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedStatus = statusFilter.value;

            const filteredData = rawData.filter(item => {
                const matchesSearch = searchTerm === '' || 
                                      item.name.toLowerCase().includes(searchTerm);
                const matchesStatus = selectedStatus === 'all' || item.status === selectedStatus;
                return matchesSearch && matchesStatus;
            });
            renderUI(filteredData);
        };
        
        searchInput.addEventListener('input', filterTable);
        statusFilter.addEventListener('change', filterTable);

        document.getElementById('addOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formMessage = document.getElementById('formMessage');
            try {
                const newOrder = {
                    date: document.getElementById('orderDate').value,
                    name: document.getElementById('productName').value,
                    qty: parseInt(document.getElementById('quantity').value),
                    price: parseFloat(document.getElementById('unitPrice').value),
                    status: document.getElementById('orderStatus').value
                };
                
                await addDoc(ordersCollection, newOrder);
                formMessage.textContent = 'Sipari≈ü ba≈üarƒ±yla kaydedildi!';
                formMessage.classList.remove('text-red-500');
                formMessage.classList.add('text-green-500');
                document.getElementById('addOrderForm').reset();
            } catch (e) {
                formMessage.textContent = 'Sipari≈ü kaydedilemedi. Hata: ' + e.message;
                formMessage.classList.remove('text-green-500');
                formMessage.classList.add('text-red-500');
            }
        });

        const initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser.uid;
                ordersCollection = collection(db, `artifacts/${appId}/users/${userId}/orders`);

                onSnapshot(ordersCollection, (snapshot) => {
                    const orders = [];
                    snapshot.forEach(doc => {
                        orders.push({ id: doc.id, ...doc.data() });
                    });
                    rawData = orders;
                    renderUI();
                });
            } catch (e) {
                document.body.innerHTML = `<div style="padding: 2rem; color: #ef4444; text-align: center; font-size: 1.5rem;">Hata: Firebase yapƒ±landƒ±rma bilgileri bulunamadƒ±. L√ºtfen <a href="https://firebase.google.com/docs/web/setup" target="_blank" style="text-decoration: underline;">Firebase Console</a>'dan bilgilerinizi alƒ±p kodu g√ºncelleyin.</div>`;
                console.error("Firebase initialization failed: ", e);
            }
        };

        window.onload = initializeFirebase;
        document.getElementById('getSummaryButton').addEventListener('click', () => getSummary('general'));
        document.getElementById('getStockSummaryButton').addEventListener('click', () => getSummary('stock'));
        window.showDetails = showDetails;
        window.closeModal = closeModal;
        window.deleteOrder = async (id) => {
            const confirmation = confirm("Bu sipari≈üi silmek istediƒüinize emin misiniz?");
            if (confirmation) {
                try {
                    await deleteDoc(doc(ordersCollection, id));
                } catch (e) {
                    alert('Sipari≈ü silinemedi. Hata: ' + e.message);
                }
            }
        };
    </script>
</body>
</html>
