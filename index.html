                              <!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silva | Aktif Stok Takip Sistemi v3.3</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2c3e50;
            --primary-light: #eaf2fb;
            --secondary-color: #50E3C2;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #9b59b6;
            --ship-color: #16a085;
            --sold-color: var(--danger-color); 
            --order-color: #2980b9; /* Sipariş Kartı için yeni renk */
            --background-color: #f4f7fc;
            --card-background-color: #ffffff;
            --text-color: #333;
            --light-text-color: #7f8c8d;
            --border-color: #e0e6ed;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --font-family: 'Poppins', sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        header { background: linear-gradient(135deg, var(--primary-dark), #1d2b4e); color: white; padding: 2.5rem; text-align: center; border-radius: 0 0 24px 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 2.5rem; }
        header h1 { font-weight: 700; font-size: 2.8rem; }
        
        /* Sekmeli Navigasyon */
        .main-nav { display: flex; gap: 0.5rem; margin-bottom: 2.5rem; border-bottom: 2px solid var(--border-color); }
        .nav-btn { background: none; border: none; padding: 1rem 1.5rem; font-size: 1.1rem; font-weight: 600; color: var(--light-text-color); cursor: pointer; transition: all 0.3s ease; border-bottom: 4px solid transparent; }
        .nav-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .page-content.hidden { display: none; }

        .card, .summary-card { background-color: var(--card-background-color); border-radius: 16px; box-shadow: var(--box-shadow); padding: 1.75rem; transition: all 0.3s ease; }
        .card:hover, .summary-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
        .card-title { margin-bottom: 1.5rem; font-weight: 600; font-size: 1.25rem; color: var(--primary-dark); border-bottom: 2px solid var(--border-color); padding-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
        #summary-section { display: flex; flex-direction: column; gap: 2.5rem; margin-bottom: 2.5rem; }
        #total-value { padding: 2.5rem; text-align: center; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        #total-value h2 { color: rgba(255, 255, 255, 0.9); font-size: 1.5rem; }
        #total-value .main-value { font-size: clamp(2.2rem, 5vw, 3.5rem); font-weight: 700; margin: 0.5rem 0; }
        #total-value .sub-value { font-size: clamp(1.2rem, 4vw, 1.8rem); font-weight: 500; color: rgba(255, 255, 255, 0.8); }
        .summary-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 2rem; }
        .summary-card { text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .summary-card h2 { font-size: 1rem; font-weight: 500; color: var(--light-text-color); margin-bottom: 0.5rem; }
        .summary-card p { font-weight: 700; margin-bottom: 0; line-height: 1.2; word-break: break-all; }
        .summary-card .main-value { font-size: clamp(1.5rem, 4vw, 2.2rem); }
        #total-stock .main-value { color: var(--primary-color); }
        #total-orders .main-value { color: var(--order-color); }
        #in-stock .main-value { color: var(--secondary-color); }
        #sold .main-value { color: var(--sold-color); }
        #critical-stock .main-value { color: var(--warning-color); }
        #on-plane .main-value { color: var(--info-color); }
        #on-ship .main-value { color: var(--ship-color); }

        #dashboard-charts { display: grid; grid-template-columns: 1fr; gap: 2.5rem; margin-bottom: 2.5rem; }
        @media (min-width: 768px) { #dashboard-charts { grid-template-columns: 1fr 1fr; } }
        @media (min-width: 1200px) { #dashboard-charts { grid-template-columns: 1fr 2fr; } }
        .chart-container { position: relative; height: 350px; }
        #form-page { max-width: 600px; margin: 0 auto; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .price-input-group { display: flex; gap: 0.5rem; align-items: center; }
        .price-input-group .input-field { flex-grow: 1; }
        .price-input-group .select-field { width: 80px; flex-shrink: 0; }
        .input-field, .select-field { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; font-family: var(--font-family); transition: all 0.3s ease; }
        .input-field[type="date"] { color: var(--text-color); }
        .input-field:focus, .select-field:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        .input-field.invalid { border-color: var(--danger-color); box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2); }
        .btn { padding: 0.9rem 1.5rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background-color: var(--primary-color); color: white; width: 100%; }
        .btn-primary:hover { background-color: #2980b9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4); }
        .btn-secondary { background-color: var(--secondary-color); color: white; width: 100%; }
        .btn-secondary:hover { background-color: #48CFAF; }
        .btn-cancel { background-color: #ecf0f1; color: var(--light-text-color); width: 100%; margin-top: 0.5rem; }
        .btn-cancel:hover { background-color: #bdc3c7; }
        .btn-action { background-color: transparent; border: 1px solid var(--border-color); color: var(--light-text-color); padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        .btn-action:hover { border-color: var(--primary-color); color: var(--primary-color); background: var(--primary-light); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger-outline { background-color: transparent; border: 1px solid var(--border-color); color: var(--danger-color); padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        .btn-danger-outline:hover { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
        .product-actions { display: flex; gap: 0.5rem; }
        #list-controls-wrapper { margin-bottom: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        #product-list-controls { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: space-between; align-items: center; }
        #search-box { width: 100%; max-width: 250px; }
        #sort-controls { display: flex; align-items: center; gap: 0.5rem; }
        .filter-buttons { display: flex; gap: 0.5rem; background-color: #e9ecef; padding: 5px; border-radius: 8px; flex-wrap: wrap;}
        .filter-btn { background: transparent; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .filter-btn.active { background: var(--card-background-color); color: var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
        #product-list { margin-top: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .product-item { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 1rem; padding: 1.25rem 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.5s ease; opacity: 1; transform: scale(1); }
        .product-item.low-stock { border-left: 5px solid var(--warning-color); }
        .low-stock-icon { color: var(--warning-color); font-size: 1.5rem; }
        .product-info .product-name { font-weight: 600; font-size: 1.1rem; }
        .product-info .product-sku { font-size: 0.8rem; color: #fff; background-color: var(--light-text-color); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-left: 0.5rem; }
        .product-info .product-meta { color: var(--light-text-color); font-size: 0.9rem; }
        .product-meta .price-usd { color: var(--text-color); font-weight: 500; }
        .product-details { display: flex; align-items: center; gap: 1rem; }
        .product-status { padding: 0.3rem 0.8rem; border-radius: 20px; font-weight: 500; font-size: 0.8rem; color: white; text-align: center; min-width: 80px; }
        .status-Stokta { background-color: var(--secondary-color); }
        .status-Satıldı { background-color: var(--sold-color); }
        .status-Uçakta { background-color: var(--info-color); }
        .status-Gemide { background-color: var(--ship-color); }
        .placeholder-message { text-align: center; padding: 3rem 1rem; border: 2px dashed var(--border-color); border-radius: 12px; }
        .placeholder-message p { color: var(--light-text-color); font-weight: 500; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { display: flex; align-items: center; gap: 10px; padding: 1rem 1.5rem; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateX(120%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { background: linear-gradient(135deg, var(--secondary-color), #2ecc71); }
        .toast-info { background: linear-gradient(135deg, var(--danger-color), #c0392b); }
        .toast-warning { background: linear-gradient(135deg, var(--primary-color), #2980b9); }
        .toast-rate { background: linear-gradient(#ffd54f, #f6b10a); font-weight: bold; font-size: 1.1rem; }
        #add-product-panel.editing { border: 2px solid var(--secondary-color); box-shadow: 0 8px 25px rgba(80, 227, 194, 0.3); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; transform: scale(0.9); transition: all 0.3s ease; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-content h3 { margin-bottom: 1rem; }
        .modal-content p { margin-bottom: 1.5rem; color: var(--light-text-color); }
        .modal-actions { display: flex; justify-content: center; gap: 1rem; }
        #log-list { display: flex; flex-direction: column; gap: 1rem; max-height: 70vh; overflow-y: auto; padding-right: 1rem; }
        .log-item { background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 5px solid var(--primary-color); display: grid; grid-template-columns: auto 1fr; gap: 1rem; align-items: center; }
        .log-icon { font-size: 1.5rem; }
        .log-details p { margin: 0; }
        .log-product-name { font-weight: 600; color: var(--primary-dark); }
        .log-change { color: var(--text-color); }
        .log-timestamp { font-size: 0.8rem; color: var(--light-text-color); }
    </style>
</head>
<body>
    <header>
        <h1>Silva | Aktif Stok Takip Sistemi <sub>v3.3</sub></h1>
    </header>

    <div class="container">
        <nav class="main-nav">
            <button class="nav-btn active" data-page="dashboard-page">📊 Yönetim Paneli</button>
            <button class="nav-btn" data-page="form-page">➕ Yeni Sipariş Ekle</button>
            <button class="nav-btn" data-page="reports-page">📖 Raporlar & Geçmiş</button>
        </nav>

        <div id="dashboard-page" class="page-content">
            <section id="summary-section">
                <div class="summary-card" id="total-value">
                    <h2>💰 TOPLAM STOK DEĞERİ</h2>
                    <p id="total-value-tl" class="main-value">₺0</p>
                    <p id="total-value-usd" class="sub-value">$0</p>
                </div>
                <div class="summary-container">
                    <div class="summary-card" id="total-stock">
                        <h2>📦 TOPLAM STOK</h2>
                        <p class="main-value">0</p>
                    </div>
                     <div class="summary-card" id="total-orders">
                        <h2>📝 TOPLAM SİPARİŞ</h2>
                        <p class="main-value">0</p>
                    </div>
                    <div class="summary-card" id="in-stock">
                        <h2>✅ STOKTA</h2>
                        <p class="main-value">0</p>
                    </div>
                    <div class="summary-card" id="critical-stock">
                        <h2>⚠️ KRİTİK STOK</h2>
                        <p class="main-value">0</p>
                    </div>
                    <div class="summary-card" id="sold">
                        <h2>🛒 SATILDI</h2>
                        <p class="main-value">0</p>
                    </div>
                     <div class="summary-card" id="on-ship">
                        <h2>🚢 GEMİDE</h2>
                        <p class="main-value">0</p>
                    </div>
                    <div class="summary-card" id="on-plane">
                        <h2>✈️ UÇAKTA</h2>
                        <p class="main-value">0</p>
                    </div>
                </div>
            </section>
    
            <section id="dashboard-charts">
                <div class="card">
                    <h2 class="card-title">Stok Durum Dağılımı</h2>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
                 <div class="card">
                    <h2 class="card-title">Aylık Sipariş Adetleri</h2>
                    <div class="chart-container">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </section>
            
            <section id="product-list-section" class="card">
                 <div class="card-title">
                    <span>Stok Listesi</span>
                    <button class="btn btn-action" id="export-csv-btn" title="Verileri CSV olarak indir">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        <span>Dışa Aktar</span>
                    </button>
                </div>
                <div id="list-controls-wrapper">
                    <div id="product-list-controls">
                        <input type="search" id="search-box" class="input-field" placeholder="🔍 Ürünlerde ara...">
                        <div id="sort-controls">
                            <label for="sort-by" style="font-weight: 500;">Sırala:</label>
                            <select id="sort-by" class="select-field">
                                <option value="createdAt_desc">Tarihe Göre (En Yeni)</option>
                                <option value="createdAt_asc">Tarihe Göre (En Eski)</option>
                                <option value="name_asc">Ürün Adı (A-Z)</option>
                                <option value="name_desc">Ürün Adı (Z-A)</option>
                                <option value="price_asc">Fiyata Göre (Artan)</option>
                                <option value="price_desc">Fiyata Göre (Azalan)</option>
                                <option value="quantity_asc">Adede Göre (Artan)</option>
                                <option value="quantity_desc">Adede Göre (Azalan)</option>
                            </select>
                        </div>
                    </div>
                     <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="Tümü">Tümü</button>
                        <button class="filter-btn" data-filter="Stokta">Stokta</button>
                        <button class="filter-btn" data-filter="Satıldı">Satıldı</button>
                        <button class="filter-btn" data-filter="Gemide">Gemide</button>
                        <button class="filter-btn" data-filter="Uçakta">Uçakta</button>
                    </div>
                </div>
                <div id="product-list">
                     <div class="placeholder-message">
                        <div class="loading-spinner"></div>
                        <p>Veriler Yükleniyor...</p>
                    </div>
                </div>
            </section>
        </div>

        <div id="form-page" class="page-content hidden">
            <main>
                <aside id="add-product-panel">
                    <div class="card">
                        <h2 class="card-title" id="form-title">Yeni Ürün Ekle</h2>
                        <form id="add-product-form">
                            <input type="hidden" id="edit-product-id">
                            <div class="form-group">
                                <label for="product-date">Sipariş Tarihi</label>
                                <input type="date" id="product-date" class="input-field" required>
                            </div>
                             <div class="form-group">
                                <label for="product-sku">Ürün Kodu</label>
                                <input type="text" id="product-sku" class="input-field" placeholder="Örn: SLV-MOP-01">
                            </div>
                            <div class="form-group">
                                <label for="product-name">Ürün Adı</label>
                                <input type="text" id="product-name" class="input-field" placeholder="Örn: El Mopu" required>
                            </div>
                            <div class="form-group">
                                <label for="product-price">Birim Fiyat</label>
                                <div class="price-input-group">
                                    <input type="number" id="product-price" class="input-field" placeholder="Örn: 250" min="0" step="0.01" required>
                                    <select id="price-currency" class="select-field">
                                        <option value="TRY">₺</option>
                                        <option value="USD">$</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="product-quantity">Adet</label>
                                <input type="number" id="product-quantity" class="input-field" placeholder="Örn: 50" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="critical-stock-level">Kritik Stok Seviyesi (Opsiyonel)</label>
                                <input type="number" id="critical-stock-level" class="input-field" placeholder="Örn: 100" min="0">
                            </div>
                            <div class="form-group">
                                <label for="product-status">Durum</label>
                                <select id="product-status" class="select-field">
                                    <option value="Stokta">Stokta</option>
                                    <option value="Satıldı">Satıldı</option>
                                    <option value="Gemide">Gemide</option>
                                    <option value="Uçakta">Uçakta</option>
                                </select>
                            </div>
                            <div id="form-buttons">
                                <button type="submit" class="btn btn-primary" id="submit-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m-7-7h14"/></svg>
                                    <span>Stoğa Ekle</span>
                                </button>
                                <button type="button" class="btn btn-cancel" id="cancel-edit-btn" style="display: none;">İptal</button>
                            </div>
                        </form>
                    </div>
                </aside>
            </main>
        </div>
        
        <div id="reports-page" class="page-content hidden">
             <section id="logs-section" class="card">
                 <div class="card-title">
                    <span>İşlem Geçmişi</span>
                </div>
                <div id="log-list">
                    <div class="placeholder-message">
                        <div class="loading-spinner"></div>
                        <p>Geçmiş yükleniyor...</p>
                    </div>
                </div>
             </section>
        </div>

    </div>
    <div id="toast-container"></div>
    
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Onay Gerekiyor</h3>
            <p>Bu ürünü kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.</p>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="btn btn-cancel">Vazgeç</button>
                <button id="modal-confirm-btn" class="btn btn-danger">Evet, Sil</button>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyASCeVzpEOhDCHyWTeza7Rnbm4U8EUc5QE",
            authDomain: "stokdepo-52630.firebaseapp.com",
            databaseURL: "https://stokdepo-52630-default-rtdb.firebaseio.com",
            projectId: "stokdepo-52630",
            storageBucket: "stokdepo-52630.firebasestorage.app",
            messagingSenderId: "698156957113",
            appId: "1:698156957113:web:632e25ada3a3bfdc9e0a68",
            measurementId: "G-45QFTCYQJF"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const productsRef = db.ref('products');
        const logsRef = db.ref('logs');

        document.addEventListener('DOMContentLoaded', async () => {
            // Element References
            const navButtons = document.querySelectorAll('.nav-btn');
            const pages = document.querySelectorAll('.page-content');
            const addProductForm = document.getElementById('add-product-form');
            const formTitle = document.getElementById('form-title');
            const submitBtn = document.getElementById('submit-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const editProductIdInput = document.getElementById('edit-product-id');
            const productNameInput = document.getElementById('product-name');
            const productPriceInput = document.getElementById('product-price');
            const priceCurrencySelect = document.getElementById('price-currency');
            const productQuantityInput = document.getElementById('product-quantity');
            const criticalStockLevelInput = document.getElementById('critical-stock-level');
            const productStatusSelect = document.getElementById('product-status');
            const productListDiv = document.getElementById('product-list');
            const logListDiv = document.getElementById('log-list');
            const toastContainer = document.getElementById('toast-container');
            const searchBox = document.getElementById('search-box');
            const filterButtonsContainer = document.querySelector('.filter-buttons');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const sortBySelect = document.getElementById('sort-by');
            const deleteModal = document.getElementById('delete-modal');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const productSkuInput = document.getElementById('product-sku');
            const productDateInput = document.getElementById('product-date');
            const pieChartCanvas = document.getElementById('pieChart');
            const lineChartCanvas = document.getElementById('lineChart');
            
            // State Variables
            let allProducts = [];
            let allLogs = [];
            let searchTerm = '';
            let activeFilter = 'Tümü';
            let activeSort = 'createdAt_desc';
            let usdToTryRate = 35.0; // Fallback
            let productToDeleteId = null;
            let pieChartInstance = null;
            let lineChartInstance = null;

            // Set default date to today
            productDateInput.value = new Date().toISOString().split('T')[0];

            const switchToPage = (pageId) => {
                pages.forEach(page => page.classList.toggle('hidden', page.id !== pageId));
                navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.page === pageId));
            };

            navButtons.forEach(btn => {
                btn.addEventListener('click', () => switchToPage(btn.dataset.page));
            });


            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                const icons = { success: '✅', info: '🗑️', warning: '✏️', rate: 'ℹ️' };
                toast.innerHTML = `<span>${icons[type] || 'ℹ️'}</span><span>${message}</span>`;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                const displayDuration = type === 'rate' ? 8000 : 4000;
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, displayDuration);
            };

            const formatCurrency = (amount, currency = 'TRY') => {
                const options = { style: 'currency', currency: currency, maximumFractionDigits: 2 };
                if (amount % 1 === 0) {
                    options.minimumFractionDigits = 0;
                    options.maximumFractionDigits = 0;
                }
                return new Intl.NumberFormat(currency === 'TRY' ? 'tr-TR' : 'en-US', options).format(amount);
            };

            const fetchAndUpdateRate = async () => {
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    if (!response.ok) throw new Error('Network response failed.');
                    const data = await response.json();
                    if (data && data.rates && data.rates.TRY) {
                        usdToTryRate = data.rates.TRY;
                        showToast(`Güncel kur: 1 USD = ${usdToTryRate.toFixed(2)} TL`, 'rate');
                    }
                } catch (error) {
                    console.error("Could not fetch exchange rate, using fallback.", error);
                    showToast(`Kur alınamadı, yaklaşık değer kullanılıyor.`, 'info');
                }
            };

            const logAction = (action, details) => {
                const logEntry = {
                    action,
                    details,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                logsRef.push(logEntry);
            };

            const updateSummary = () => {
                const activeProducts = allProducts.filter(p => p.status !== 'Satıldı');
                const soldProducts = allProducts.filter(p => p.status === 'Satıldı');

                const totalOrders = allProducts.length;
                const totalStock = activeProducts.reduce((sum, p) => sum + p.quantity, 0);
                const inStock = activeProducts.filter(p => p.status === 'Stokta').reduce((sum, p) => sum + p.quantity, 0);
                const onShip = activeProducts.filter(p => p.status === 'Gemide').reduce((sum, p) => sum + p.quantity, 0);
                const onPlane = activeProducts.filter(p => p.status === 'Uçakta').reduce((sum, p) => sum + p.quantity, 0);
                const criticalStockCount = allProducts.filter(p => p.status === 'Stokta' && p.criticalStock && p.quantity < p.criticalStock).length;
                const totalValueTL = activeProducts.reduce((sum, p) => sum + (p.quantity * p.price), 0);
                const totalValueUSD = totalValueTL / usdToTryRate;
                const totalSold = soldProducts.reduce((sum, p) => sum + p.quantity, 0);

                document.querySelector('#total-orders .main-value').textContent = totalOrders;
                document.querySelector('#total-stock .main-value').textContent = totalStock;
                document.querySelector('#in-stock .main-value').textContent = inStock;
                document.querySelector('#on-ship .main-value').textContent = onShip;
                document.querySelector('#on-plane .main-value').textContent = onPlane;
                document.querySelector('#sold .main-value').textContent = totalSold;
                document.querySelector('#critical-stock .main-value').textContent = criticalStockCount;
                document.querySelector('#total-value-tl').textContent = formatCurrency(totalValueTL, 'TRY');
                document.querySelector('#total-value-usd').textContent = formatCurrency(totalValueUSD, 'USD');
            };
            
            const renderPieChart = () => {
                const statusCounts = allProducts.reduce((acc, product) => {
                    if (product && product.status) {
                        acc[product.status] = (acc[product.status] || 0) + product.quantity;
                    }
                    return acc;
                }, {});

                const labels = Object.keys(statusCounts);
                const data = Object.values(statusCounts);
                const colors = labels.map(label => {
                    if (label === 'Stokta') return getComputedStyle(document.documentElement).getPropertyValue('--secondary-color');
                    if (label === 'Satıldı') return getComputedStyle(document.documentElement).getPropertyValue('--sold-color');
                    if (label === 'Gemide') return getComputedStyle(document.documentElement).getPropertyValue('--ship-color');
                    if (label === 'Uçakta') return getComputedStyle(document.documentElement).getPropertyValue('--info-color');
                    return '#ccc';
                });

                if(pieChartInstance) {
                    pieChartInstance.data.labels = labels;
                    pieChartInstance.data.datasets[0].data = data;
                    pieChartInstance.data.datasets[0].backgroundColor = colors;
                    pieChartInstance.update();
                } else {
                    pieChartInstance = new Chart(pieChartCanvas, {
                        type: 'doughnut', data: { labels, datasets: [{ label: 'Ürün Adedi', data, backgroundColor: colors, borderColor: '#fff', borderWidth: 2 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
                    });
                }
            };

            const renderLineChart = () => {
                const monthlyData = allProducts.reduce((acc, product) => {
                    if (product && product.date) {
                        const month = product.date.substring(0, 7);
                        acc[month] = (acc[month] || 0) + product.quantity;
                    }
                    return acc;
                }, {});
                
                const sortedMonths = Object.keys(monthlyData).sort();
                const labels = sortedMonths.map(month => new Date(month + '-02').toLocaleString('tr-TR', { month: 'long', year: '2-digit' }));
                const data = sortedMonths.map(month => monthlyData[month]);

                if(lineChartInstance) {
                    lineChartInstance.data.labels = labels;
                    lineChartInstance.data.datasets[0].data = data;
                    lineChartInstance.update();
                } else {
                    lineChartInstance = new Chart(lineChartCanvas, {
                        type: 'line',
                        data: { labels, datasets: [{ label: 'Sipariş Edilen Ürün Adedi', data, fill: true, borderColor: 'var(--primary-color)', backgroundColor: 'rgba(52, 152, 219, 0.1)', tension: 0.1 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                    });
                }
            };

            const renderProducts = () => {
                let processedProducts = allProducts;
                if (activeFilter !== 'Tümü') {
                    processedProducts = processedProducts.filter(p => p.status === activeFilter);
                }
                if (searchTerm) {
                    processedProducts = processedProducts.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()) || (p.sku && p.sku.toLowerCase().includes(searchTerm.toLowerCase())));
                }
                const [key, direction] = activeSort.split('_');
                processedProducts.sort((a, b) => {
                    let valA = a[key], valB = b[key];
                    if (key === 'name' || key === 'sku') {
                        valA = (valA || '').toLowerCase(); valB = (valB || '').toLowerCase();
                    }
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });
                
                productListDiv.innerHTML = '';
                if (processedProducts.length === 0) {
                     productListDiv.innerHTML = `<div class="placeholder-message"><p>Gösterilecek ürün bulunamadı.</p></div>`;
                } else {
                    processedProducts.forEach(product => {
                        const productElement = document.createElement('div');
                        const isLowStock = product.status === 'Stokta' && product.criticalStock && product.quantity < product.criticalStock;
                        productElement.className = `product-item ${isLowStock ? 'low-stock' : ''}`;
                        productElement.dataset.id = product.id;
                        const priceUSD = product.price / usdToTryRate;
                        const displayDate = product.date ? new Date(product.date).toLocaleDateString('tr-TR') : 'Tarih Yok';
                        productElement.innerHTML = `
                            ${isLowStock ? '<div class="low-stock-icon">⚠️</div>' : '<div></div>'}
                            <div class="product-info">
                                <div>
                                    <span class="product-name">${product.name}</span>
                                    ${product.sku ? `<span class="product-sku">${product.sku}</span>` : ''}
                                </div>
                                <div class="product-meta">
                                    <span>${displayDate}</span> &bull;
                                    <span>${product.quantity} Adet</span> &bull;
                                    <span class="price-usd">${formatCurrency(product.price, 'TRY')} / ${formatCurrency(priceUSD, 'USD')}</span>
                                </div>
                            </div>
                            <div class="product-details">
                                <span class="product-status status-${product.status}">${product.status}</span>
                                <div class="product-actions">
                                    <button class="btn btn-action edit-btn" title="Düzenle">✏️</button>
                                    <button class="btn btn-danger-outline delete-btn" title="Sil">🗑️</button>
                                </div>
                            </div>`;
                        productListDiv.appendChild(productElement);
                    });
                }
            };
            
            const renderLogs = () => {
                logListDiv.innerHTML = '';
                if (allLogs.length === 0) {
                    logListDiv.innerHTML = `<div class="placeholder-message"><p>Henüz bir işlem geçmişi yok.</p></div>`;
                } else {
                    allLogs.forEach(log => {
                        const logElement = document.createElement('div');
                        logElement.className = 'log-item';
                        const logDate = new Date(log.timestamp).toLocaleString('tr-TR');
                        const icons = {'Oluşturuldu': '➕', 'Güncellendi': '✏️', 'Silindi': '🗑️'};
                        logElement.innerHTML = `
                            <div class="log-icon">${icons[log.action] || 'ℹ️'}</div>
                            <div class="log-details">
                                <p><span class="log-product-name">${log.details.productName || ''}</span> - ${log.action}</p>
                                <p class="log-change">${log.details.change || ''}</p>
                                <p class="log-timestamp">${logDate}</p>
                            </div>
                        `;
                        logListDiv.appendChild(logElement);
                    });
                }
            };

            const resetForm = () => {
                addProductForm.reset();
                editProductIdInput.value = '';
                priceCurrencySelect.value = 'TRY';
                productDateInput.value = new Date().toISOString().split('T')[0];
                formTitle.textContent = 'Yeni Ürün Ekle';
                submitBtn.querySelector('span').textContent = 'Stoğa Ekle';
                submitBtn.classList.remove('btn-secondary');
                submitBtn.classList.add('btn-primary');
                document.querySelector('#add-product-panel').classList.remove('editing');
                cancelEditBtn.style.display = 'none';
                document.querySelectorAll('.input-field.invalid').forEach(el => el.classList.remove('invalid'));
            };

            const validateForm = () => {
                let isValid = true;
                document.querySelectorAll('.input-field.invalid').forEach(el => el.classList.remove('invalid'));
                if (!productNameInput.value.trim()) {
                    productNameInput.classList.add('invalid'); isValid = false;
                }
                const price = parseFloat(productPriceInput.value);
                if (isNaN(price) || price < 0) {
                    productPriceInput.classList.add('invalid'); isValid = false;
                }
                const quantity = parseInt(productQuantityInput.value);
                if (isNaN(quantity) || quantity <= 0) {
                    productQuantityInput.classList.add('invalid'); isValid = false;
                }
                if (!productDateInput.value) {
                    productDateInput.classList.add('invalid'); isValid = false;
                }
                return isValid;
            };

            addProductForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!validateForm()){
                    showToast('Lütfen kırmızı alanları düzeltin.', 'info'); return;
                }
                const price = parseFloat(productPriceInput.value);
                const currency = priceCurrencySelect.value;
                const priceInTry = currency === 'USD' ? price * usdToTryRate : price;
                const criticalStock = parseInt(criticalStockLevelInput.value) || 0;

                const productData = {
                    name: productNameInput.value.trim(),
                    sku: productSkuInput.value.trim(),
                    date: productDateInput.value,
                    price: priceInTry,
                    quantity: parseInt(productQuantityInput.value),
                    status: productStatusSelect.value,
                    criticalStock: criticalStock
                };
                const editId = editProductIdInput.value;

                if (editId) {
                    const oldProduct = allProducts.find(p => p.id === editId);
                    let changes = [];
                    Object.keys(productData).forEach(key => {
                        if (String(productData[key]) !== String(oldProduct[key])) {
                            changes.push(`${key}: "${oldProduct[key] || ''}" -> "${productData[key] || ''}"`);
                        }
                    });

                    if(changes.length > 0){
                        productsRef.child(editId).update(productData).then(() => {
                            logAction('Güncellendi', { productName: productData.name, change: changes.join(', ') });
                            showToast('Ürün başarıyla güncellendi!', 'success'); resetForm(); switchToPage('dashboard-page');
                        });
                    } else {
                         showToast('Değişiklik yapılmadı.', 'warning');
                         resetForm(); 
                         switchToPage('dashboard-page');
                    }
                } else {
                    productData.createdAt = firebase.database.ServerValue.TIMESTAMP;
                    productsRef.push(productData).then((newRef) => {
                         logAction('Oluşturuldu', { productName: productData.name, productId: newRef.key });
                         showToast('Ürün başarıyla kaydedildi!', 'success'); resetForm(); productNameInput.focus(); switchToPage('dashboard-page');
                    });
                }
            });

            productListDiv.addEventListener('click', (e) => {
                const editButton = e.target.closest('.edit-btn');
                if (editButton) {
                    switchToPage('form-page');
                    const productId = editButton.closest('.product-item').dataset.id;
                    const product = allProducts.find(p => p.id === productId);
                    if (product) {
                        editProductIdInput.value = product.id;
                        productNameInput.value = product.name;
                        productSkuInput.value = product.sku || '';
                        productDateInput.value = product.date;
                        productPriceInput.value = product.price.toFixed(2);
                        priceCurrencySelect.value = 'TRY';
                        productQuantityInput.value = product.quantity;
                        criticalStockLevelInput.value = product.criticalStock || '';
                        productStatusSelect.value = product.status;
                        formTitle.textContent = 'Ürünü Düzenle';
                        submitBtn.querySelector('span').textContent = 'Değişiklikleri Kaydet';
                        submitBtn.classList.replace('btn-primary', 'btn-secondary');
                        document.querySelector('#add-product-panel').classList.add('editing');
                        cancelEditBtn.style.display = 'block';
                        productNameInput.focus();
                        showToast(`"${product.name}" düzenleniyor...`, 'warning');
                    }
                }
                const deleteButton = e.target.closest('.delete-btn');
                if(deleteButton){
                    productToDeleteId = deleteButton.closest('.product-item').dataset.id;
                    deleteModal.classList.add('show');
                }
            });

            modalConfirmBtn.addEventListener('click', () => {
                if(productToDeleteId){
                    const productToDelete = allProducts.find(p => p.id === productToDeleteId);
                    productsRef.child(productToDeleteId).remove()
                        .then(() => {
                            logAction('Silindi', { productName: productToDelete.name });
                            showToast('Ürün silindi.', 'info');
                        });
                    deleteModal.classList.remove('show');
                    productToDeleteId = null;
                }
            });

            modalCancelBtn.addEventListener('click', () => deleteModal.classList.remove('show'));
            deleteModal.addEventListener('click', (e) => {
                if(e.target === deleteModal) deleteModal.classList.remove('show');
            });
            
            cancelEditBtn.addEventListener('click', () => {
                resetForm();
                switchToPage('dashboard-page');
            });
            searchBox.addEventListener('input', (e) => { searchTerm = e.target.value; renderProducts(); });
            sortBySelect.addEventListener('change', (e) => { activeSort = e.target.value; renderProducts(); });
            filterButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    filterButtonsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    activeFilter = e.target.dataset.filter;
                    renderProducts();
                }
            });

             exportCsvBtn.addEventListener('click', () => {
                if (allProducts.length === 0) {
                    showToast('Dışa aktarılacak ürün yok.', 'info'); return;
                }
                const headers = 'Tarih,Ürün Kodu,Ürün Adı,Birim Fiyat (TL),Birim Fiyat (USD),Adet,Durum,Toplam Değer (TL),Toplam Değer (USD)\n';
                const rows = allProducts.map(p => {
                    const totalTL = p.price * p.quantity;
                    const priceUSD = p.price / usdToTryRate;
                    const totalUSD = totalTL / usdToTryRate;
                    return `${p.date},"${p.sku}","${p.name}",${p.price.toFixed(2)},${priceUSD.toFixed(2)},${p.quantity},${p.status},${totalTL.toFixed(2)},${totalUSD.toFixed(2)}`;
                }).join('\n');
                
                const blob = new Blob([`\uFEFF${headers + rows}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'stok-listesi.csv';
                link.click();
                URL.revokeObjectURL(link.href);
                showToast('Stok listesi indiriliyor...', 'success');
            });

            await fetchAndUpdateRate();

            productsRef.on('value', snapshot => {
                const productsData = snapshot.val();
                allProducts = productsData ? Object.keys(productsData).map(key => ({ id: key, ...productsData[key] })) : [];
                updateSummary();
                renderProducts();
                renderPieChart();
                renderLineChart();
            });

            logsRef.orderByChild('timestamp').limitToLast(100).on('value', snapshot => {
                const logsData = snapshot.val();
                allLogs = logsData ? Object.keys(logsData).map(key => ({ id: key, ...logsData[key] })).reverse() : [];
                renderLogs();
            });
        });
    </script>
</body>
</html>
